# 中文 Web 搜索上下文为空问题调试总结

## 问题描述

在开启 web search 时：
- 英文查询 "who win 2025 grammy prize" 能正常工作，返回正确结果
- 中文查询 "哪些人获得了2025年格莱美奖" 时上下文为空，最终查询结果错误

## 根本原因分析

通过调试发现，问题出现在 **BM25 内容过滤器对中文内容过度过滤**：

### 原始问题
1. **BM25 阈值设置问题**：
   - 中文查询使用阈值 `0.3`（过低）
   - 英文查询使用阈值 `1.2`
   - 低阈值导致几乎所有中文内容都被过滤掉

2. **内容过滤结果**：
   - 中文页面：爬取后内容长度只有 1 字符
   - 英文页面：正常获取完整内容

3. **向量数据库结果**：
   - 中文：0 个文档块 → 查询返回空上下文
   - 英文：11+ 个文档块 → 正常返回相关内容

## 解决方案

### 1. 调整 BM25 阈值策略
```python
# 修改前
if re.search(r'[\u4e00-\u9fff]', prompt):
    bm25_filter = BM25ContentFilter(user_query=prompt, bm25_threshold=0.3)  # 太低
else:
    bm25_filter = BM25ContentFilter(user_query=prompt, bm25_threshold=1.2)

# 修改后
if is_chinese:
    bm25_filter = BM25ContentFilter(user_query=prompt, bm25_threshold=0.1)  # 更低阈值，减少过滤
else:
    bm25_filter = BM25ContentFilter(user_query=prompt, bm25_threshold=1.2)
```

### 2. 添加内容回退机制
当 BM25 过滤后的内容太少时，自动使用原始 markdown 内容：

```python
# 如果中文查询的内容太少，尝试使用原始内容
if is_chinese and content_length < 50:
    if hasattr(result, 'markdown') and result.markdown:
        result.markdown_v2.fit_markdown = result.markdown
```

### 3. 优化文本分割器
```python
text_splitter = RecursiveCharacterTextSplitter(
    chunk_size=500,     # 增加块大小（原 400）
    chunk_overlap=150,  # 增加重叠（原 100）
    separators=["\n\n", "\n", "。", "？", "！", ". ", ", ", " ", ""]  # 优化分隔符
)
```

### 4. 增强调试和监控
- 添加详细的内容长度监控
- 显示向量查询结果统计
- 提供清晰的错误信息

## 修复效果对比

### 修复前
| 语言 | 页面内容 | 文档块数 | 上下文长度 | 结果 |
|------|----------|----------|------------|------|
| 英文 | 1587/685/1098 字符 | 11 个 | 1311 字符 | ✅ 正常 |
| 中文 | 1/1/1 字符 | 0 个 | 0 字符 | ❌ 失败 |

### 修复后
| 语言 | 页面内容 | 文档块数 | 上下文长度 | 结果 |
|------|----------|----------|------------|------|
| 英文 | 2741/1098/10605 字符 | 44 个 | 1518 字符 | ✅ 正常 |
| 中文 | 10650/478/5904 字符 | 52 个 | 1601 字符 | ✅ 正常 |

## 关键改进点

1. **BM25 阈值调整**：从 0.3 调整到 0.1，减少对中文内容的过度过滤
2. **内容回退机制**：当过滤内容太少时自动使用原始内容
3. **文本分割优化**：增加块大小和重叠，提高中文处理效果
4. **调试信息增强**：提供详细的处理过程监控

## 使用建议

1. **运行调试脚本**：使用 `python debug_search.py` 测试搜索功能
2. **监控日志**：注意观察内容长度和文档块数量
3. **调整阈值**：如果仍有问题，可以进一步降低中文BM25阈值到 0.05
4. **内容质量**：某些网站可能有反爬机制，需要选择合适的搜索结果

## 技术要点

- **BM25 算法**：对不同语言的敏感度不同，需要针对性调整
- **中文分词**：中文文本的语义匹配与英文不同，需要更宽松的过滤策略
- **内容回退**：确保即使过滤失败也能获取基本内容
- **向量匹配**：使用多语言嵌入模型确保中英文都能正确匹配 